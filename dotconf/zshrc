#!/usr/bin/env zsh
if [[ "$(arch)" == "arm64" ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ "$(arch)" == "x86_64" || "$(arch)" == "i386" ]]; then
  eval "$(/usr/local/bin/brew shellenv)"
else
  echo "invalid archiecture: $(arch)"
  return 1
fi
export PATH="$(brew --prefix)/bin:$PATH"
# apply llvm from homebrew
export PATH="$(brew --prefix llvm)/bin:$PATH"
export PATH="$(brew --prefix coreutils)/libexec/gnubin:$PATH"

# ┌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┐
# ╎                      zimfw Pre-Init                       ╎
# └╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┘
# autoloads
autoload -Uz colors && colors
autoload -Uz /usr/local/share/zsh/functions/*(:t)

autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^E' edit-command-line


if macos-is-light; then
  export TERM_THEME="light"
  export FZF_DEFAULT_OPTS="
    --color=fg:#B7B5AC,bg:#FFFCF0,hl:#100F0F
    --color=fg+:#B7B5AC,bg+:#F2F0E5,hl+:#100F0F
    --color=border:#AF3029,header:#100F0F,gutter:#FFFCF0
    --color=spinner:#3AA99F,info:#3AA99F,separator:#F2F0E5
    --color=pointer:#D0A215,marker:#D14D41,prompt:#D0A215"
else
  export TERM_THEME="dark"
  export FZF_DEFAULT_OPTS=$FZF_DEFAULT_OPTS'
    --color=fg:#d0d0d0,fg+:#CECDC3,bg:#100F0F,bg+:#1C1B1A
    --color=hl:#8B7EC8,hl+:#5E409D,info:#CECDC3,marker:#879A39
    --color=prompt:#5E409D,spinner:#CE5D97,pointer:#5E409D,header:#575653
    --color=gutter:#100F0F,border:#282726,preview-bg:#1C1B1A,preview-label:#282726
    --color=label:#282726,query:#d9d9d9,disabled:#575653
    --preview-window="border-rounded" --prompt="󰄾" --marker="󰅂" --pointer="󰫢"
    --separator="─" --scrollbar="│"'
fi

# apply zsh styles
source "$HOME/.zstyles"

# ┌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┐
# ╎                        zimfw Init                         ╎
# └╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┘
ZIM_HOME=${ZDOTDIR:-${HOME}}/.zim
# Download zimfw plugin manager if missing.
if [[ ! -e ${ZIM_HOME}/zimfw.zsh ]]; then
  if (( ${+commands[curl]} )); then
    curl -fsSL --create-dirs -o "$ZIM_HOME/zimfw.zsh" "https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh"
  else
    mkdir -p ${ZIM_HOME} && wget -nv -O ${ZIM_HOME}/zimfw.zsh https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
  fi
fi
# Install missing modules, and update ${ZIM_HOME}/init.zsh if missing or outdated.
if [[ ! ${ZIM_HOME}/init.zsh -nt ${ZIM_CONFIG_FILE:-${ZDOTDIR:-${HOME}}/.zimrc} ]]; then
  source ${ZIM_HOME}/zimfw.zsh init
fi
# zim init
source ${ZIM_HOME}/init.zsh

# ┌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┐
# ╎                      zimfw Post-Init                      ╎
# └╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┘
zmodload -F zsh/terminfo +p:terminfo

source "$HOME/.zsh_custom/fz.sh" #TODO(@s0cks): wtf is this?
source "$HOME/.zkeys"
source "$HOME/.zaliases"
source <(pay-respects zsh)

#TODO(@s0cks): is this necessary?
if (( $+command[docker] )); then
  fpath=("$HOME/.docker/completions" $fpath)
fi

# luarocks
if [[ $+commands[luarocks] ]]; then
  source <(luarocks path)
fi

# llvm
#TODO(@s0cks): convert this to: s0cks tc activate ${DEFAULT_TOOLCHAIN:-homebrew-llvm}
source "$USER_DATA_HOME/toolchains/${DEFAULT_TOOLCHAIN:-homebrew-llvm}"

# set fast-zsh-highlighting theme to flexoki-dark/light based on MacOS theme
#TODO(@s0cks): figure out how to get this in zstyles?
if [[ $(uname) == "Darwin" ]]; then
  if macos-is-dark; then
    fast-theme -q XDG:flexoki-dark
  else
    fast-theme -q XDG:flexoki-light
  fi
fi

#TODO(@s0cks): remove this once these values are configured  properly using the theme
unset ZLS_COLORS
unset LS_COLORS
