#!/usr/bin/env zsh
autoload -Uz colors && colors

local DOTFILES_DIR="${DOTFILES_HOME:-/usr/local/share/dotfiles}"
local NEOVIM_DIR="${NEOVIM_HOME:-$XDG_CONFIG_HOME/nvim}"
local WEZTERM_DIR="${WEZTERM_HOME:-$XDG_CONFIG_HOME/wezterm}"
local HAMMERSPOON_DIR="${HAMMERSPOON_DIR:-$XDG_CONFIG_HOME/hammerspoon}"

local function __done() {
  echo "$fg[green]${reset_color} done."
}

local function __updated() {
  local name="$1"
  echo "$fg[green] $fg[bold]$fg[magenta]$name$reset_color updated to: $(git log -1 --pretty='%h %B')"
}

local function __updating() {
  echo "updating $bold$fg[magenta]$1$reset_color...."
}

local function __pull_changes() {
  local name="$1"
  git pull --recurse-submodules &>/dev/null
  if (( "$?" != 0 )); then
    echo "$fg[red] failed. Can't update $name $(git rev-parse --abbrev-ref HEAD) from remote: $(git remote get-url origin)"
    return 1
  fi
  return 0
}

local function __no_updates() {
  echo "$bold$fg[yellow] $reset_color skipped, no updates."
}

s0cks() {
  local VERSION="0.0.1"
  local USAGE=(
    "Usage: s0cks [-h|--help] [<command>]"
    "General Options:"
    "  -h|--help        # Print help and usage info"
    ""
    "Commands:"
    "  update-dotfiles      # Update the installed dotfiles"
  )
  local show_version() {
    printf "s0cks %s\n" "$VERSION"
  }

  local update_dotfiles() {
    pushd "$DOTFILES_DIR/"
    local prev="$(git log -1 --pretty='%h')"
    __updating "dotfiles"
    __pull_changes "dotfiles"

    task install &>/dev/null
    if (( "$?" != 0)); then
      echo "$fg[red]${reset_color} failed to install dotfiles"
      return 1
    fi

    local crev="$(git log -1 --pretty='%h')"
    if [[ "$prev" != "$crev" ]]; then
      __updated "dotfiles"
    else
      __no_updates
    fi
    popd
  }

  local __update_app_config() {
    pushd "$2"
    local prev="$(git log -1 --pretty='%h')"
    __updating "$1"
    __pull_changes "$1"

    local crev="$(git log -1 --pretty='%h')"
    if [[ "$prev" != "$crev" ]]; then
      __updated "$1"
    else
      __no_updates
    fi
    popd
  }

  local command=()
  # local flag_verbose=false
  # local filename=myfile

  opterr() {
    echo >&2 "optparsing_demo: Unknown option '$1'"
  }


  while (( $# )); do
    case $1 in
      --)                 shift; command+=("${@[@]}"); break      ;;
      -h|--help)          printf "%s\n" $USAGE && return          ;;
      -v|--version)       show_version && return                  ;;
      # -v|--verbose)       flag_verbose=true                     ;;
      # -f|--filename)      shift; filename=$1                    ;;
      # -f=*|--filename=*)  filename="${1#*=}"                    ;;
      -*)                 opterr $1 && return 2                   ;;
      *)                  command+=("${@[@]}"); break             ;;
    esac
    shift
  done

  case "$command" in
    version)                  show_version && return                ;;
    update)
      case "$@" in
        dotfiles)           update_dotfiles                                          ;;
        nvim|neovim)        __update_app_config "Neovim" "$NEOVIM_DIR"               ;;
        wez|wezterm)        __update_app_config "WezTerm" "$WEZTERM_DIR"             ;;
        hs|hammerspoon)     __update_app_config "Hammerspoon" "$HAMMERSPOON_DIR"     ;;
        *)                  echo "invalid tool: $@" && return 2                      ;;
      esac
      return
      ;; 
    *)                      opterr "$@" && return 2               ;;
  esac
}
