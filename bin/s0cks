#!/usr/bin/env zsh
autoload -Uz colors && colors

s0cks() {
  local VERSION="0.0.1"
  local USAGE=(
    "Usage: s0cks [-h|--help] [<command>]"
    "General Options:"
    "  -h|--help        # Print help and usage info"
    ""
    "Commands:"
    "  update-dotfiles      # Update the installed dotfiles"
  )
  local dotfiles_home="${DOTFILES_HOME:-/usr/local/share/dotfiles}"

  local show_version() {
    printf "s0cks %s\n" "$VERSION"
  }

  local update_neovim() {
    echo "updating $bold$fg[magenta]Neovim$reset_color config...."
    pushd "$XDG_CONFIG_HOME/nvim/"
    git pull --recurse-submodules &>/dev/null
    if (( "$?" != 0)); then
      echo "$fg[red] failed to pull $(git rev-parse --abbrev-ref HEAD) changes from remote: $(git remote get-url origin)"
      return 1
    fi
    echo "$fg[green]$reset_color success!"
    popd
  }

  local update_dotfiles() {
    pushd "$dotfiles_home/"
    echo "updating $fg[bold]@s0cks/$fg[magenta]dotfiles$reset_color...."
    git pull --recurse-submodules &>/dev/null
    if (( "$?" != 0)); then
      echo "$fg[red] failed to pull $(git rev-parse --abbrev-ref HEAD) changes from remote: $(git remote get-url origin)"
      return 1
    fi

    task install &>/dev/null
    if (( "$?" != 0)); then
      echo "$fg[red]${reset_color} failed to install dotfiles"
      return 1
    fi
    popd 
    echo "$fg[green]${reset_color} done."
  }


  local command=()
  # local flag_verbose=false
  # local filename=myfile

  opterr() {
    echo >&2 "optparsing_demo: Unknown option '$1'"
  }

  while (( $# )); do
    case $1 in
      --)                 shift; command+=("${@[@]}"); break      ;;
      -h|--help)          printf "%s\n" $USAGE && return          ;;
      -v|--version)       show_version && return                  ;;
      # -v|--verbose)       flag_verbose=true                     ;;
      # -f|--filename)      shift; filename=$1                    ;;
      # -f=*|--filename=*)  filename="${1#*=}"                    ;;
      -*)                 opterr $1 && return 2                   ;;
      *)                  command+=("${@[@]}"); break             ;;
    esac
    shift
  done

  case "$command" in
    version)                  show_version && return                ;;
    update-dotfiles)          update_dotfiles && return             ;;
    update-neovim)            update_neovim && return               ;;
    *)                        opterr "$@" && return 2               ;;
  esac
}
