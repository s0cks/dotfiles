#!/usr/bin/env zsh
autoload -Uz colors && colors

local DOTFILES_DIR="${DOTFILES_HOME:-/usr/local/share/dotfiles}"
local NEOVIM_DIR="${NEOVIM_HOME:-$XDG_CONFIG_HOME/nvim}"
local WEZTERM_DIR="${WEZTERM_HOME:-$XDG_CONFIG_HOME/wezterm}"

local function __done() {
  echo "$fg[green]${reset_color} done."
}

local function __updated() {
  local name="$1"
  echo "$fg[green] $fg[bold]$fg[magenta]$name$reset_color updated to: $(git log -1 --pretty='%h %B')"
}

local function __updating() {
  echo "updating $bold$fg[magenta]$1$reset_color...."
}

local function __pull_changes() {
  local name="$1"
  git pull --recurse-submodules &>/dev/null
  if (( "$?" != 0 )); then
    echo "$fg[red] failed. Can't update $name $(git rev-parse --abbrev-ref HEAD) from remote: $(git remote get-url origin)"
    return 1
  fi
  return 0
}

s0cks() {
  local VERSION="0.0.1"
  local USAGE=(
    "Usage: s0cks [-h|--help] [<command>]"
    "General Options:"
    "  -h|--help        # Print help and usage info"
    ""
    "Commands:"
    "  update-dotfiles      # Update the installed dotfiles"
  )
  local dotfiles_home="${DOTFILES_HOME:-/usr/local/share/dotfiles}"
  local wezterm_dir="${WEZTERM_HOME:-$HOME/.config/wezterm}"

  local show_version() {
    printf "s0cks %s\n" "$VERSION"
  }

  local update_neovim() {
    pushd "$XDG_CONFIG_HOME/nvim/"
    __updating "Neovim"
    __pull_changes "Neovim"
    __updated "Neovim"
    popd
  }

  local update_dotfiles() {
    pushd "$dotfiles_home/"
    __updating "dotfiles"
    __pull_changes "dotfiles"

    task install &>/dev/null
    if (( "$?" != 0)); then
      echo "$fg[red]${reset_color} failed to install dotfiles"
      return 1
    fi
    __updated "dotfiles"
    popd
  }

  local update_wezterm() {
    pushd "$wezterm_dir/"
    __updating "WezTerm"
    __pull_changes "WezTerm"
    __updated "WezTerm"
    popd
  }

  local command=()
  # local flag_verbose=false
  # local filename=myfile

  opterr() {
    echo >&2 "optparsing_demo: Unknown option '$1'"
  }

  while (( $# )); do
    case $1 in
      --)                 shift; command+=("${@[@]}"); break      ;;
      -h|--help)          printf "%s\n" $USAGE && return          ;;
      -v|--version)       show_version && return                  ;;
      # -v|--verbose)       flag_verbose=true                     ;;
      # -f|--filename)      shift; filename=$1                    ;;
      # -f=*|--filename=*)  filename="${1#*=}"                    ;;
      -*)                 opterr $1 && return 2                   ;;
      *)                  command+=("${@[@]}"); break             ;;
    esac
    shift
  done

  case "$command" in
    version)                  show_version && return                ;;
    update-dotfiles)          update_dotfiles && return             ;;
    update-neovim)            update_neovim && return               ;;
    update-wezterm)           update_wezterm && return              ;;
    *)                        opterr "$@" && return 2               ;;
  esac
}
