#!/usr/bin/env zsh

zsecrets() {
  local ZPROFILE_SECRETS_FILE="${ZPROFILE_SECRETS_FILE:-$HOME/.zprofile_secrets.gpg}"
  if [[ ! -v GPG_ID ]]; then
    echo "GPG_ID environment variable is not set"
    return 1
  fi

  local decrypt_to_temp() {
    local zsecrets_file=$(mktemp -p /tmp zsecrets.XXXXX)
    gpg --quiet --yes -d -o "$zsecrets_file" "$ZPROFILE_SECRETS_FILE"
    echo "$zsecrets_file"
  }

  local encrypt_and_rm() {
    local zsecrets_file="$1"
    gpg --quiet --yes -e -r "$GPG_ID" -o "$ZPROFILE_SECRETS_FILE" "$zsecrets_file"
    rm -rf "$zsecrets_file"
  }

  local view_secrets() {
    local zsecrets_file=$(decrypt_to_temp)
    if [[ $+commands[bat] ]]; then
      bat "$zsecrets_file"
    else
      cat "$zsecrets_file" | less
    fi
    rm -rf "$zsecrets_file"
  }

  local edit_secrets() {
    local zsecrets_file=$(decrypt_to_temp)
    $EDITOR "$zsecrets_file"
    source "$zsecrets_file"
    encrypt_and_rm "$zsecrets_file"
  }

  local VERSION="0.0.1"
  local USAGE=(
    "Usage: zsecrets [-h|--help] [<cmd>]"
    "General Options:"
    "  -h|--help        # Print help and usage info"
    "  -v|--version     # Print the version" 
    ""
    "commands:"
    "  show|view        # View the current secrets in the environment" 
  )

  local show_version() {
    printf "s0cks %s\n" "$VERSION"
  }

  local opterr() {
    echo >&2 "zsecrets: Unknown option '$1'"
  }

  local show_help() {
    printf "%s\n" $USAGE
  }

  local cmd=()
  while (( $# )); do
    case $1 in
      --)
        shift;
        cmd+=("${@[@]}");
        break
        ;;
      -h|--help)
        show_help
        return
        ;;
      -v|--version)
        show_version
        return
        ;;
      *)
        cmd+=("${@[@]}");
        break
        ;;
    esac
    shift
  done

  if (( "${#cmd[@]}" == 0)); then
    show_help
    return
  fi

  case "${cmd[1]}" in
    show|view)
      view_secrets
      return
      ;;
    edit)
      edit_secrets
      return
      ;;
    *)
      opterr "${cmd[@]}" && return 2
      ;;
  esac
}
